<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¸ŒëŸ¬ì‰¬ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        header { background: #333; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        .container { display: flex; flex: 1; overflow: hidden; }
        
        /* â–¼â–¼â–¼ [ìˆ˜ì •ëœ ë¶€ë¶„] ë„ˆë¹„ë¥¼ 350px -> 180pxë¡œ ì¤„ì„ â–¼â–¼â–¼ */
        .list-panel { 
            width: 180px; 
            background: white; 
            border-right: 1px solid #ddd; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
        }
        /* â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–² */

        .search-box { padding: 10px; border-bottom: 1px solid #eee; }
        .search-box input { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 12px; }
        
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-row { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .item-row:hover { background: #f8f9fa; }
        .item-row.active { background: #e3f2fd; border-left: 4px solid #2196f3; }
        
        /* ì¢ì•„ì§„ í­ì— ë§ì¶° ê¸€ì í¬ê¸° ì•½ê°„ ì¡°ì ˆ */
        .item-header { display: flex; justify-content: space-between; margin-bottom: 3px; font-weight: bold; font-size: 13px; }
        .item-sub { font-size: 11px; color: #666; display: flex; justify-content: space-between; }
        
        .chart-panel { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .chart-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 400px; position: relative; }
        .info-card { margin-bottom: 15px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #loading { text-align: center; padding: 20px; color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ“Š êµì²´ í˜„í™©</h1>
        <button onclick="loadStats()" style="padding: 5px 10px; cursor:pointer; font-size:12px;">ìƒˆë¡œê³ ì¹¨</button>
    </header>
    <div class="container">
        <div class="list-panel">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ìœ„ì¹˜ ê²€ìƒ‰" onkeyup="filterList()">
            </div>
            <div id="loading">ë¡œë”©ì¤‘...</div>
            <ul class="item-list" id="brushList"></ul>
        </div>
        <div class="chart-panel">
            <div class="info-card">
                <h3 id="detailTitle" style="margin-top:0; font-size:16px;">ì„ íƒëœ ë¸ŒëŸ¬ì‰¬ ì—†ìŒ</h3>
                <p id="detailText" style="font-size:14px; color:#555;">ëª©ë¡ì—ì„œ ì„ íƒí•˜ì„¸ìš”.</p>
            </div>
            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>
    <script>
        // â–¼â–¼â–¼ ë³¸ì¸ êµ¬ê¸€ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œ ì…ë ¥ â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyn5VaSQ0Fd21EgY5OcHQRPc7-oRpwQTiGzoaJlXnWeNCPPpM3CWUynSGPnjYKb5LO7jg/exec"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let allData = []; 
        let myChart = null; 

        window.onload = loadStats;

        function loadStats() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('brushList').innerHTML = '';
            
            fetch(`${SCRIPT_URL}?action=getStats`)
            .then(res => res.json())
            .then(data => {
                allData = data; 
                renderList(data); 
                document.getElementById('loading').style.display = 'none';

                const params = new URLSearchParams(window.location.search);
                const pUnit = params.get('unit');     
                const pLoc = params.get('location');  

                if(pUnit && pLoc) {
                    document.getElementById('searchInput').value = pLoc;
                    filterList();
                    setTimeout(() => {
                        const items = document.querySelectorAll('.item-row');
                        for(let item of items) {
                            if(item.innerText.includes(pUnit) && item.innerText.includes(pLoc)) {
                                item.click(); 
                                break;
                            }
                        }
                    }, 200); 
                }
            })
            .catch(err => alert("ë¡œë”© ì‹¤íŒ¨: " + err));
        }

        function renderList(data) {
            const list = document.getElementById('brushList');
            list.innerHTML = "";
            
            data.forEach(item => {
                let dateStr = "-";
                if(item.lastDate) {
                    const d = new Date(item.lastDate);
                    // ë‚ ì§œë¥¼ 24.12.31 í˜•íƒœë¡œ ì§§ê²Œ ì¤„ì„ (ê³µê°„ í™•ë³´)
                    dateStr = `${d.getFullYear().toString().slice(2)}.${d.getMonth()+1}.${d.getDate()}`;
                }
                const li = document.createElement('li');
                li.className = 'item-row';
                
                li.setAttribute('data-unit', item.unit);
                li.setAttribute('data-location', item.location);
                
                li.onclick = () => loadHistory(item, li);
                li.innerHTML = `
                    <div class="item-header">
                        <span>${item.location}</span>
                        <span style="color:${item.count > 5 ? 'red' : 'green'}">${item.count}íšŒ</span>
                    </div>
                    <div class="item-sub">
                        <span>${item.unit}</span>
                        <span>${dateStr}</span>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function filterList() {
            const keyword = document.getElementById('searchInput').value.toUpperCase();
            const filtered = allData.filter(item => 
                item.location.toUpperCase().includes(keyword) || 
                String(item.unit).includes(keyword)
            );
            renderList(filtered);
        }

        function loadHistory(item, element) {
            document.querySelectorAll('.item-row').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('detailTitle').innerText = `[${item.unit}] ${item.location}`;
            document.getElementById('detailText').innerText = "ë°ì´í„° ë¶„ì„ ì¤‘...";

            fetch(`${SCRIPT_URL}?action=getHistory&location=${encodeURIComponent(item.location)}&unit=${encodeURIComponent(item.unit)}`)
            .then(res => res.json())
            .then(dates => {
                drawChart(dates);
                document.getElementById('detailText').innerText = `ì´ ${dates.length}ë²ˆ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('detailText').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            });
        }

        function drawChart(dateStrings) {
            const ctx = document.getElementById('myChart').getContext('2d');
            const dates = dateStrings.map(d => new Date(d)).sort((a,b) => a-b);
            const labels = [];
            const diffDays = [];

            for(let i=1; i<dates.length; i++) {
                const diffTime = Math.abs(dates[i] - dates[i-1]);
                const diffDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                const d2 = dates[i].toISOString().slice(2,10).replace(/-/g,'.');
                labels.push(`${d2}`); 
                diffDays.push(diffDay); 
            }

            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‚¬ìš© ê¸°ê°„ (ì¼)',
                        data: diffDays,
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'ì‚¬ìš© ì¼ìˆ˜' } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'êµì²´ ì£¼ê¸° ì¶”ì´ ê·¸ë˜í”„' } }
                }
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¸ŒëŸ¬ì‰¬ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 0; background: #f0f2f5; height: 100vh; display: flex; flex-direction: column; }
        header { background: #333; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.2rem; }
        .container { display: flex; flex: 1; overflow: hidden; }
        .list-panel { width: 350px; background: white; border-right: 1px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; }
        .search-box { padding: 15px; border-bottom: 1px solid #eee; }
        .search-box input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .item-list { list-style: none; padding: 0; margin: 0; }
        .item-row { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .item-row:hover { background: #f8f9fa; }
        .item-row.active { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .item-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
        .item-sub { font-size: 0.85rem; color: #666; display: flex; justify-content: space-between; }
        .chart-panel { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); height: 400px; position: relative; }
        .info-card { margin-bottom: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #loading { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ“Š ë¸ŒëŸ¬ì‰¬ êµì²´ í˜„í™©</h1>
        <button onclick="loadStats()" style="padding: 5px 10px; cursor:pointer;">ìƒˆë¡œê³ ì¹¨</button>
    </header>
    <div class="container">
        <div class="list-panel">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ìœ„ì¹˜ ê²€ìƒ‰ (ì˜ˆ: C/Y-4A)" onkeyup="filterList()">
            </div>
            <div id="loading">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <ul class="item-list" id="brushList"></ul>
        </div>
        <div class="chart-panel">
            <div class="info-card">
                <h2 id="detailTitle" style="margin-top:0;">ì„ íƒëœ ë¸ŒëŸ¬ì‰¬ ì—†ìŒ</h2>
                <p id="detailText">ì™¼ìª½ ëª©ë¡ì—ì„œ ë¸ŒëŸ¬ì‰¬ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ê¸°ë¡ê³¼ ê·¸ë˜í”„ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
            </div>
            <div class="chart-container">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </div>
    <script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— ë°©ê¸ˆ ë³µì‚¬í•œ ìƒˆ ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”! â–¼â–¼â–¼
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyn5VaSQ0Fd21EgY5OcHQRPc7-oRpwQTiGzoaJlXnWeNCPPpM3CWUynSGPnjYKb5LO7jg/exec"; 
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        let allData = []; 
        let myChart = null; 

        window.onload = loadStats;

        function loadStats() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('brushList').innerHTML = '';
            
            fetch(`${SCRIPT_URL}?action=getStats`)
            .then(res => res.json())
            .then(data => {
                allData = data; 
                renderList(data); 
                document.getElementById('loading').style.display = 'none';
            })
            .catch(err => alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + err));
        }

        function renderList(data) {
            const list = document.getElementById('brushList');
            list.innerHTML = "";
            
            data.forEach(item => {
                let dateStr = "-";
                if(item.lastDate) {
                    const d = new Date(item.lastDate);
                    dateStr = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
                }
                const li = document.createElement('li');
                li.className = 'item-row';
                li.onclick = () => loadHistory(item, li);
                li.innerHTML = `
                    <div class="item-header">
                        <span>${item.location}</span>
                        <span style="color:${item.count > 5 ? 'red' : 'green'}">${item.count}íšŒ</span>
                    </div>
                    <div class="item-sub">
                        <span>${item.unit}</span>
                        <span>${dateStr}</span>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function filterList() {
            const keyword = document.getElementById('searchInput').value.toUpperCase();
            const filtered = allData.filter(item => 
                item.location.toUpperCase().includes(keyword) || 
                String(item.unit).includes(keyword)
            );
            renderList(filtered);
        }

        function loadHistory(item, element) {
            document.querySelectorAll('.item-row').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('detailTitle').innerText = `[${item.unit}] ${item.location}`;
            document.getElementById('detailText').innerText = "ë°ì´í„° ë¶„ì„ ì¤‘...";

            // [ìˆ˜ì •ë¨] í˜¸ê¸°(unit) ì •ë³´ê¹Œì§€ ê°™ì´ ë³´ë‚´ì„œ ì •í™•í•œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            fetch(`${SCRIPT_URL}?action=getHistory&location=${encodeURIComponent(item.location)}&unit=${encodeURIComponent(item.unit)}`)
            .then(res => res.json())
            .then(dates => {
                drawChart(dates);
                document.getElementById('detailText').innerText = `ì´ ${dates.length}ë²ˆ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            })
            .catch(err => {
                console.error(err);
                document.getElementById('detailText').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            });
        }

        function drawChart(dateStrings) {
            const ctx = document.getElementById('myChart').getContext('2d');
            const dates = dateStrings.map(d => new Date(d)).sort((a,b) => a-b);
            const labels = [];
            const diffDays = [];

            for(let i=1; i<dates.length; i++) {
                const diffTime = Math.abs(dates[i] - dates[i-1]);
                const diffDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                const d2 = dates[i].toISOString().slice(2,10).replace(/-/g,'.');
                labels.push(`${d2}`); 
                diffDays.push(diffDay); 
            }

            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‚¬ìš© ê¸°ê°„ (ì¼)',
                        data: diffDays,
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'ì‚¬ìš© ì¼ìˆ˜' } } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'êµì²´ ì£¼ê¸° ì¶”ì´ ê·¸ë˜í”„' } }
                }
            });
        }
    </script>
</body>
</html>
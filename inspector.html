<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>브러쉬 이력 조회 (확인용)</title>
    <style>
        /* 스타일은 기존과 동일하되, 텍스트 스타일 추가 */
        :root {
            --yard-bg: #f3e5f5;
            --yard-header: #9c27b0;
            --boiler-bg: #fff8e1;
            --boiler-header: #fbc02d;
            --btn-base: #fff;
            --btn-hover: #e3f2fd;
        }

        body {
            font-family: 'Malgun Gothic', sans-serif;
            padding: 20px;
            background: #fafafa;
        }

        /* [수정됨] 헤더 스타일 변경 */
        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Arial', 'Helvetica', sans-serif;
            /* 깔끔한 고딕 폰트 */
            font-weight: 800;
            /* 아주 굵게 */
            font-size: 2.2rem;
            /* 폰트 크기 키움 */
            color: #1a1a1a;
            /* 기본 진한 검정색 */
            letter-spacing: -0.5px;
            /* 자간 살짝 좁게 */
        }

        /* [추가됨] Manager 텍스트를 위한 파란색 스타일 */
        .title-highlight {
            color: #2962ff;
            /* 쨍한 파란색 */
        }

        .unit-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .unit-btn {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px 45px;
            font-size: 20px;
            font-weight: 800;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            color: #757575;
            position: relative;
        }

        .unit-btn.unit-3 {
            border-bottom: 4px solid #2962ff;
        }

        .unit-btn.unit-4 {
            border-bottom: 4px solid #e03131;
        }

        .unit-btn.unit-3.active {
            background: #eef2ff;
            color: #2962ff;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(41, 98, 255, 0.15);
        }

        .unit-btn.unit-4.active {
            background: #fff5f5;
            color: #e03131;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(224, 49, 49, 0.15);
        }

        .unit-btn:hover:not(.active) {
            background: #fafafa;
            border-color: #ccc;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .direction-section {
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
        }

        .yard-theme .section-header {
            background-color: var(--yard-header);
        }

        .yard-theme .content {
            background-color: var(--yard-bg);
        }

        .boiler-theme .section-header {
            background-color: var(--boiler-header);
        }

        .boiler-theme .content {
            background-color: var(--boiler-bg);
        }

        .content {
            display: flex;
            padding: 15px;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .equipment-part {
            flex: 1;
            min-width: 300px;
        }

        .part-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #444;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
            padding-bottom: 5px;
        }

        /* 그리드 및 버튼 스타일 */
        .grid-wrapper {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
        }

        .brush-btn {
            background-color: var(--btn-base);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px 2px;
            /* 패딩 살짝 줄임 */
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            height: 60px;
            /* 높이를 살짝 키움 (글씨 2줄 들어가야 함) */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .brush-btn:hover {
            background-color: var(--btn-hover);
            border-color: #2196f3;
        }

        /* 버튼 내부 텍스트 스타일 */
        .btn-code {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }

        .btn-count {
            font-size: 11px;
            color: #e03131;
            font-weight: bold;
        }

        /* 빨간색 누적 횟수 */

        /* 구분선 */
        .grid-wrapper>div:nth-child(8n+4) {
            position: relative;
        }

        .grid-wrapper>div:nth-child(8n+4)::after {
            content: "";
            position: absolute;
            right: -6px;
            top: 5px;
            bottom: 5px;
            width: 2px;
            background-color: #d1d1d1;
            border-radius: 2px;
        }

        /* 로딩 표시 */
        #loadingMsg {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        /* [추가] 월별 통계 보드 스타일 */
        .monthly-stats-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .monthly-stat-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 4px 15px;
            min-width: 140px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-bottom: 2px solid #2962ff;
        }

        .monthly-stat-card.nav-card {
            cursor: pointer;
            background: #fcfcfc;
            border-bottom-color: #e03131;
            justify-content: center;
            align-items: center;
            gap: 2px;
        }

        .monthly-stat-card.nav-card:hover {
            background: #eef2ff;
            border-bottom-color: #2962ff;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1px 0;
        }

        .stat-row:not(:last-child) {
            border-bottom: 1px dashed #eee;
        }

        .month-label {
            font-size: 12px;
            color: #757575;
            font-weight: 600;
        }

        .month-count {
            font-size: 17px;
            font-weight: 800;
            color: #1a1a1a;
        }

        .month-count span {
            font-size: 11px;
            margin-left: 2px;
            color: #2962ff;
            font-weight: bold;
        }

        .nav-text {
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }

        .nav-sub-text {
            font-size: 10px;
            color: #888;
        }

        .stat-row.clickable:hover {
            background: #f0f7ff;
            color: #2962ff;
        }

        /* [추가] 아코디언 스타일 상세 내역 */
        .accordion-content {
            display: none;
            padding: 10px 5px;
            background: #fcfcfc;
            border-top: 1px dashed #eee;
            margin-top: 5px;
            text-align: left;
        }

        .accordion-content.active {
            display: block;
        }

        .mini-btn-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .mini-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            color: #444;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .mini-btn strong {
            color: #2962ff;
        }
    </style>
</head>

<body>

    <!-- [수정됨] 텍스트 및 스타일 적용 -->
    <h2>Generator Brush <span class="title-highlight">Manager</span></h2>

    <div id="loadingMsg">데이터 불러오는 중...</div>

    <div class="unit-selector">
        <button class="unit-btn unit-3 active" onclick="setUnit(3)">#3</button>
        <button class="unit-btn unit-4" onclick="setUnit(4)">#4</button>
    </div>

    <!-- [추가] 월별 교체 개수 보드 -->
    <div id="monthly-stats-board" class="monthly-stats-container"></div>

    <div class="main-container">
        <div class="direction-section yard-theme">
            <div class="section-header">YARD 방향</div>
            <div class="content">
                <div class="equipment-part">
                    <div class="part-title">COLLECTOR (C/Y)</div>
                    <div class="grid-wrapper" id="grid-CY"></div>
                </div>
                <div class="equipment-part">
                    <div class="part-title">TURBINE (T/Y)</div>
                    <div class="grid-wrapper" id="grid-TY"></div>
                </div>
            </div>
        </div>
        <div class="direction-section boiler-theme">
            <div class="section-header">BOILER 방향</div>
            <div class="content">
                <div class="equipment-part">
                    <div class="part-title">COLLECTOR (C/B)</div>
                    <div class="grid-wrapper" id="grid-CB"></div>
                </div>
                <div class="equipment-part">
                    <div class="part-title">TURBINE (T/B)</div>
                    <div class="grid-wrapper" id="grid-TB"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // [1] 구글 앱스 스크립트 주소 (통계 데이터 받아오기용) - 필수 입력!
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyn5VaSQ0Fd21EgY5OcHQRPc7-oRpwQTiGzoaJlXnWeNCPPpM3CWUynSGPnjYKb5LO7jg/exec";

        // [2] 대시보드 주소 (그래프 보러 가기용) - 필수 입력!
        const DASHBOARD_URL = "https://kdy871.github.io/brush-manager/dashboard.html";
        // =========================================================================

        let currentUnit = 3;
        let globalStats = []; // 받아온 통계 데이터를 저장할 곳

        const levelMapping = { 4: { left: 4, right: 8 }, 3: { left: 3, right: 7 }, 2: { left: 2, right: 6 }, 1: { left: 1, right: 5 } };
        const cols = ['A', 'B', 'C', 'D'];

        // 시작하자마자 데이터부터 가져옵니다
        window.onload = function () {
            fetchStats();
        };

        // 통계 데이터 가져오기 함수
        function fetchStats() {
            const msg = document.getElementById('loadingMsg');

            // 1. 로컬 스토리지 캐시 확인
            const cachedData = localStorage.getItem('brush_stats_cache');
            if (cachedData) {
                try {
                    globalStats = JSON.parse(cachedData);
                    msg.style.display = 'none';
                    init(); // 캐시 데이터로 즉시 화면 그리기
                } catch (e) {
                    console.error("캐시 파싱 실패:", e);
                }
            } else {
                msg.style.display = 'block';
            }

            // 2. 백그라운드에서 최신 데이터 가져오기
            fetch(`${SCRIPT_URL}?action=getStats`)
                .then(res => res.json())
                .then(data => {
                    globalStats = data; // 최신 데이터 저장
                    localStorage.setItem('brush_stats_cache', JSON.stringify(data)); // 캐시 업데이트
                    msg.style.display = 'none';
                    init(); // 화면 갱신
                })
                .catch(err => {
                    console.error(err);
                    // 캐시가 없을 때만 에러 메시지 표시
                    if (!globalStats || globalStats.length === 0) {
                        msg.innerText = "데이터 로딩 실패 (새로고침 해주세요)";
                        init();
                    }
                });
        }

        function createGrid(elementId, prefix, orderList) {
            const container = document.getElementById(elementId);
            container.innerHTML = "";
            orderList.forEach(level => {
                const map = levelMapping[level];
                cols.forEach(col => createBtn(container, prefix, map.left, col));
                cols.forEach(col => createBtn(container, prefix, map.right, col));
            });
        }

        function createBtn(container, prefix, num, col) {
            const btnCode = `${prefix}-${num}${col}`; // 예: C/Y-4A
            const btn = document.createElement('div');
            btn.className = 'brush-btn';

            // [핵심] 현재 호기와 위치에 맞는 카운트 찾기
            // 데이터 형식: { unit: "3호기", location: "C/Y-4A", count: 5 ... }
            const myStat = globalStats.find(item =>
                item.unit == `${currentUnit}호기` && item.location == btnCode
            );

            // 카운트가 있으면 "누적 N회", 없으면 "-"
            const countText = myStat ? `누적 ${myStat.count}회` : "-";
            // 많이 교체된 것(5회 이상)은 더 진하게 표시 (선택사항)
            const countColor = (myStat && myStat.count >= 5) ? "#d90429" : "#e03131";

            btn.innerHTML = `
                <div class="btn-code">${btnCode}</div>
                <div class="btn-count" style="color:${countColor}">${countText}</div>
            `;

            // 클릭 시 대시보드 이동
            btn.onclick = function () {
                const targetUrl = `${DASHBOARD_URL}?unit=${encodeURIComponent(currentUnit + '호기')}&location=${encodeURIComponent(btnCode)}`;
                // iframe 내에서 이동을 시도합니다. 새 창을 원하시면 window.open을 사용하세요.
                window.location.href = targetUrl;
            };
            container.appendChild(btn);
        }

        function init() {
            const yardOrder = [4, 3, 2, 1];
            const boilerOrder = [1, 2, 3, 4];

            // 버튼을 그릴 때마다 globalStats 데이터를 참고해서 숫자를 넣습니다.
            createGrid('grid-CY', 'C/Y', yardOrder);
            createGrid('grid-TY', 'T/Y', yardOrder);
            createGrid('grid-CB', 'C/B', boilerOrder);
            createGrid('grid-TB', 'T/B', boilerOrder);

            // [추가] 월별 보드 업데이트
            updateMonthlyBoard();
        }

        function setUnit(unit) {
            currentUnit = unit;
            document.querySelectorAll('.unit-btn').forEach(b => b.classList.remove('active'));

            // 클릭된 버튼을 찾아 active 추가 (이름 기반 또는 인덱스 기반)
            const btns = document.querySelectorAll('.unit-btn');
            if (unit === 3) btns[0].classList.add('active');
            else btns[1].classList.add('active');

            // 호기를 바꾸면 화면을 다시 그려서 (3호기용/4호기용) 숫자를 업데이트합니다.
            init();
        }

        // [수정됨] 월별 교체 개수 집계 및 표시 함수 (2개 카드 레이아웃)
        function updateMonthlyBoard() {
            const board = document.getElementById('monthly-stats-board');
            if (!board) return;
            board.innerHTML = "";

            // 1. 현재 호기 데이터 필터링 (날짜 데이터가 있는 것만)
            const unitStats = globalStats.filter(item =>
                item.unit == `${currentUnit}호기` && item.lastDate
            );

            // 2. 월별로 그룹화 (YYYY-MM 형식)
            const monthlyCounts = {};
            unitStats.forEach(item => {
                const date = new Date(item.lastDate);
                if (isNaN(date.getTime())) return;

                const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyCounts[yearMonth] = (monthlyCounts[yearMonth] || 0) + 1;
            });

            // 3. 월 역순 정렬
            const sortedMonths = Object.keys(monthlyCounts).sort().reverse();

            // 현재 월과 이전 월 계산
            const now = new Date();
            const currKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const prevKey = `${lastMonthDate.getFullYear()}-${String(lastMonthDate.getMonth() + 1).padStart(2, '0')}`;

            const currCount = monthlyCounts[currKey] || 0;
            const prevCount = monthlyCounts[prevKey] || 0;

            // 카드 1: 이번달/지난달 실적
            const statCard = document.createElement('div');
            statCard.className = 'monthly-stat-card';
            statCard.innerHTML = `
                <div class="stat-row clickable" onclick="toggleMonthlyDetail('curr', '${currKey}')">
                    <span class="month-label">이번 달 (${now.getMonth() + 1}월)</span>
                    <span class="month-count">${currCount}<span>개</span></span>
                </div>
                <div id="currDetailContainer" class="accordion-content"></div>
                
                <div class="stat-row clickable" onclick="toggleMonthlyDetail('prev', '${prevKey}')">
                    <span class="month-label">지난 달 (${lastMonthDate.getMonth() + 1}월)</span>
                    <span class="month-count">${prevCount}<span>개</span></span>
                </div>
                <div id="prevDetailContainer" class="accordion-content"></div>
            `;
            board.appendChild(statCard);

            // 카드 2: 전체보기 버튼
            const navCard = document.createElement('div');
            navCard.className = 'monthly-stat-card nav-card';
            navCard.innerHTML = `
                <div class="nav-text">전체 통계 보기</div>
                <div class="nav-sub-text">월별 교체 이력 확인 →</div>
            `;
            navCard.onclick = () => {
                window.location.href = `./monthly_stats.html?unit=${currentUnit}`;
            };
            board.appendChild(navCard);
        }

        // [수정됨] 아코디언 방식으로 상세 내역 토글
        function toggleMonthlyDetail(type, monthKey) {
            const containerId = type === 'curr' ? 'currDetailContainer' : 'prevDetailContainer';
            const container = document.getElementById(containerId);
            const otherContainer = document.getElementById(type === 'curr' ? 'prevDetailContainer' : 'currDetailContainer');

            // 다른 쪽이 열려있으면 닫기
            if (otherContainer) otherContainer.classList.remove('active');

            if (container.classList.contains('active')) {
                container.classList.remove('active');
                return;
            }

            // 실적 데이터 필터링
            const details = globalStats.filter(item => {
                if (item.unit != `${currentUnit}호기` || !item.lastDate) return false;
                const d = new Date(item.lastDate);
                const k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                return k === monthKey;
            });

            if (details.length === 0) {
                container.innerHTML = "<div style='font-size:11px; color:#999; text-align:center;'>내역 없음</div>";
            } else {
                details.sort((a, b) => new Date(b.lastDate) - new Date(a.lastDate));

                let html = '<div class="mini-btn-container">';
                details.forEach(item => {
                    const d = new Date(item.lastDate);
                    const dateStr = `${d.getMonth() + 1}.${d.getDate()}`;
                    html += `
                        <div class="mini-btn">
                            <strong>${item.location}</strong> <span>(${dateStr})</span>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }

            container.classList.add('active');
        }
    </script>
</body>

</html>